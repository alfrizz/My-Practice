#!/usr/bin/env bash
set -euo pipefail

PROJECT="/mnt/g/My Drive/Ingegneria/Data Science GD/My-Practice"
REQS="$PROJECT/scripts/requirements.txt"
CONTAINER="gpu-jl"

for pkg in "$@"; do
  echo "ðŸš€ Installing '$pkg' in containerâ€¦"
  docker start "$CONTAINER" 2>/dev/null || true
  if docker exec -u root "$CONTAINER" python -m pip install --no-cache-dir "$pkg"; then
    name=$(docker exec "$CONTAINER" pip show "${pkg%%[=<>]*}" \
             | awk '/^Name:/ {print $2}')
    ver=$(docker exec "$CONTAINER" pip show "$name" \
             | awk '/^Version:/ {print $2}')
    line="$name==$ver"

    if ! grep -Fxq "$line" "$REQS"; then
      # ensure a trailing newline
      if ! tail -c1 "$REQS" | read -r _; then
        echo "" | sudo tee -a "$REQS" >/dev/null
      fi

      # append the new requirement as root
      echo "$line" | sudo tee -a "$REQS" >/dev/null
      echo "âœ… Added '$line' to requirements.txt"
    else
      echo "â„¹ï¸  '$line' already in requirements.txt"
    fi
  else
    echo "âŒ Failed to install '$pkg'; not touching requirements.txt"
  fi
done

# finally, re-sort/uniquify the file (also as root)
sudo sort -u "$REQS" -o "$REQS"

# rebuild the jupyter service image
cd /home/alfrizz/scripts
docker-compose -f docker-compose.yml build --no-cache jupyter

# push image to docker hub
if [ -z "$(docker info --format '{{.Username}}' 2>/dev/null)" ]; then docker login; fi
docker image inspect alfrizz/gpu-jl:latest >/dev/null 2>&1 || docker tag gpu-jl:latest alfrizz/gpu-jl:latest
docker push alfrizz/gpu-jl:latest

# avoid name conflicts: stop and remove any existing container named gpu-jl
docker stop gpu-jl 2>/dev/null || true
docker rm gpu-jl 2>/dev/null || true

# start the service from the freshly built image
docker-compose -f docker-compose.yml up -d --no-deps jupyter



